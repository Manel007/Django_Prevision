{% extends "layouts/base.html" %}

{% block title %} Culture List {% endblock title %}

{% block stylesheets %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
{% endblock stylesheets %}

{% block content %}
<div class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Culture List</h4>
                    <a href="{% url 'culture_create' %}" class="btn btn-primary">Create New Culture</a>
                </div>
                <div class="card-body">
                    <input type="text" id="searchInput" placeholder="Search for cultures..." class="form-control mb-3" onkeyup="searchCultures()">

                    <div class="table-responsive">
                        <table class="table tablesorter" id="cultureTable">
                            <thead class="text-primary">
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for culture in cultures %}
                                    <tr>
                                        <td>{{ culture.nom }}</td>
                                        <td>{{ culture.type_culture }}</td>
                                        <td class="text-center">
                                            <a href="{% url 'culture_update' culture.id %}" class="btn btn-warning">Edit</a>
                                            <a href="javascript:void(0);" onclick="confirmDelete('{{ culture.nom }}', '{% url 'culture_delete' culture.id %}')">Delete</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
<script>
function searchCultures() {
    let input = document.getElementById('searchInput');
    let filter = input.value.toLowerCase();
    let table = document.getElementById('cultureTable');
    let tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) { // Start from 1 to skip the header
        let tdName = tr[i].getElementsByTagName('td')[0];
        let tdType = tr[i].getElementsByTagName('td')[1];

        if (tdName || tdType) {
            let nameValue = tdName.textContent || tdName.innerText;
            let typeValue = tdType.textContent || tdType.innerText;

            if (nameValue.toLowerCase().indexOf(filter) > -1 || typeValue.toLowerCase().indexOf(filter) > -1) {
                tr[i].style.display = ""; // Show the row
            } else {
                tr[i].style.display = "none"; // Hide the row
            }
        }       
    }
}
function confirmDelete(cultureName, deleteUrl) {
    console.log("Culture to delete:", cultureName);
    console.log("Delete URL:", deleteUrl);

    swal({
        title: "Are you sure?",
        text: "You really want to delete the culture: " + cultureName + "?",
        icon: "warning",
        buttons: ["Cancel", "Delete"],
        dangerMode: true,
    }).then((willDelete) => {
        if (willDelete) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ confirm: true }),
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            }).then(data => {
                if (data.success) {
                    swal("Deleted!", "The culture has been deleted.", "success")
                        .then(() => window.location.reload());
                } else {
                    swal("Error!", "There was a problem deleting the culture: " + (data.error || "unknown error"), "error");
                }
            }).catch(error => {
                console.error('Error:', error);
                swal("Error!", "There was a problem deleting the culture.", "error");
            });
        }
    });
}


</script>
{% endblock javascripts %}
